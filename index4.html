<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale-1.0">
  <title>Painel de Tarefas Pós-Venda</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .task-card {
        transition: all 0.3s ease;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

  <div class="container mx-auto p-4 md:p-8 max-w-4xl">
    <header class="relative text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-900">Painel de Tarefas Pós-Venda</h1>
      <p class="text-gray-600 mt-2">Gerencie as pendências dos clientes com status "FECHADO".</p>
      
      <div class="absolute top-0 right-0">
         <button id="refresh-btn" class="bg-white p-2 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-700 transition-colors duration-200 shadow" title="Atualizar a lista">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.691L7.98 12.01M16.023 9.348L7.98 12.01m0 0L7.98 12.01m7.046-2.662L7.98 12.01m0 0L2.985 6.965m0 0v4.992m0 0h4.992m-4.993 0l3.181-3.183a8.25 8.25 0 0111.667 0l3.181 3.183" />
            </svg>
         </button>
      </div>
    </header>

    <main id="tasks-container" class="space-y-4">
      <!-- As tarefas serão carregadas aqui -->
    </main>
    
    <!-- Modelo de Tarefa (escondido) -->
    <div id="task-template" class="hidden bg-white p-5 rounded-lg task-card">
        <div class="flex flex-col md:flex-row md:items-center justify-between">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 md:mb-0" data-lead-name></h2>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500" data-created-at></span>
                <button class="toggle-done-btn p-2 rounded-full transition-colors duration-200">
                    <!-- Ícone de Check/Uncheck -->
                </button>
            </div>
        </div>
        <div class="mt-4 space-y-3">
            <div>
                <label class="block text-sm font-medium text-gray-700">Documentos / Comentários</label>
                <textarea class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" rows="3" data-comments></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Data de Contato</label>
                <input type="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" data-contact-date>
            </div>
        </div>
        <div class="mt-4 flex justify-end">
            <button class="save-btn bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-sm">Salvar</button>
        </div>
    </div>
    
    <!-- Estado de Carregamento -->
    <div id="loading-state" class="text-center py-10">
        <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2 text-gray-600">Carregando tarefas...</p>
    </div>

    <!-- Estado Vazio -->
    <div id="empty-state" class="hidden text-center py-16 bg-white rounded-lg">
         <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-100">
            <svg class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
         </div>
        <h3 class="mt-5 text-xl font-semibold text-gray-900">Nenhuma tarefa pendente</h3>
        <p class="mt-1 text-sm text-gray-500">Quando um lead for "FECHADO" na planilha, a tarefa aparecerá aqui.</p>
    </div>
    
    <!-- Estado de Erro -->
    <div id="error-state" class="hidden text-center py-10 bg-red-50 p-4 rounded-lg">
        <h3 class="text-lg font-medium text-red-800">Ocorreu um Erro</h3>
        <p class="mt-1 text-sm text-red-700">Não foi possível carregar as tarefas. Verifique as permissões e a configuração do Firebase.</p>
    </div>

  </div>

  <script type="module">
    // Importações do Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

    // Configuração do Firebase (CHAVE DO SEU NOVO PROJETO)
    const firebaseConfig = {
        apiKey: "AIzaSyC1mGiPh3yFeCGuOud-nC17K7mas8tJuMs",
        authDomain: "meu-painel-de-tarefas-d1926.firebaseapp.com",
        projectId: "meu-painel-de-tarefas-d1926",
        storageBucket: "meu-painel-de-tarefas-d1926.firebasestorage.app",
        messagingSenderId: "357152933295",
        appId: "1:357152933295:web:7d447e8b142e25b1c6db5a"
    };

    // Variáveis Globais
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // Inicialização do Firebase
    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (error) {
        console.error("Erro ao inicializar o Firebase:", error);
        showErrorState();
    }

    // Elementos do DOM
    const tasksContainer = document.getElementById('tasks-container');
    const taskTemplate = document.getElementById('task-template');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const errorState = document.getElementById('error-state');
    const refreshBtn = document.getElementById('refresh-btn');

    // Funções de UI
    const showLoadingState = () => {
        loadingState.classList.remove('hidden');
        emptyState.classList.add('hidden');
        errorState.classList.add('hidden');
        tasksContainer.innerHTML = '';
    };

    const showEmptyState = () => {
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        errorState.classList.add('hidden');
    };
    
    const showErrorState = () => {
        loadingState.classList.add('hidden');
        emptyState.classList.add('hidden');
        errorState.classList.remove('hidden');
    };

    const showTasks = () => {
        loadingState.classList.add('hidden');
        emptyState.classList.add('hidden');
        errorState.classList.add('hidden');
    };
    
    // Evento do botão de atualizar
    refreshBtn.addEventListener('click', () => {
        location.reload();
    });
    
    // Lógica principal
    function setupRealtimeListener() {
        const tasksCollectionPath = `artifacts/${appId}/public/data/tasks`;
        const q = query(collection(db, tasksCollectionPath), orderBy("createdAt", "desc"));
        
        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                showEmptyState();
                return;
            }

            tasksContainer.innerHTML = '';
            showTasks();

            snapshot.forEach(doc => {
                const task = doc.data();
                const taskId = doc.id;
                const taskElement = createTaskElement(taskId, task);
                tasksContainer.appendChild(taskElement);
            });

        }, (error) => {
            console.error("Erro ao buscar tarefas: ", error);
            showErrorState();
        });
    }

    function createTaskElement(id, task) {
        const clone = taskTemplate.cloneNode(true);
        clone.classList.remove('hidden');
        clone.id = `task-${id}`;

        const leadNameEl = clone.querySelector('[data-lead-name]');
        const commentsEl = clone.querySelector('[data-comments]');
        const contactDateEl = clone.querySelector('[data-contact-date]');
        const createdAtEl = clone.querySelector('[data-created-at]');
        const toggleDoneBtn = clone.querySelector('.toggle-done-btn');
        const saveBtn = clone.querySelector('.save-btn');
        
        leadNameEl.textContent = task.leadName || 'Lead sem nome';
        commentsEl.value = task.comments || '';
        contactDateEl.value = task.contactDate || '';
        
        if (task.createdAt) {
           createdAtEl.textContent = `Criado em: ${task.createdAt.toDate().toLocaleDateString('pt-BR')}`;
        } else {
           createdAtEl.textContent = 'Data indisponível';
        }

        // Estilo do botão e do card baseado no status 'isDone'
        updateTaskAppearance(clone, toggleDoneBtn, task.isDone);

        toggleDoneBtn.addEventListener('click', () => {
            const newStatus = !task.isDone;
            updateTaskStatus(id, newStatus);
        });

        saveBtn.addEventListener('click', async () => {
            saveBtn.textContent = 'Salvando...';
            saveBtn.disabled = true;
            try {
                const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, id);
                await updateDoc(taskRef, {
                    comments: commentsEl.value,
                    contactDate: contactDateEl.value
                });
            } catch (error) {
                console.error("Erro ao salvar a tarefa:", error);
            } finally {
                saveBtn.textContent = 'Salvar';
                saveBtn.disabled = false;
            }
        });

        return clone;
    }
    
    function updateTaskAppearance(cardElement, buttonElement, isDone) {
         if (isDone) {
            cardElement.classList.add('bg-green-50', 'border-l-4', 'border-green-500');
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            buttonElement.classList.add('bg-green-100');
        } else {
            cardElement.classList.remove('bg-green-50', 'border-l-4', 'border-green-500');
            buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            buttonElement.classList.remove('bg-green-100');
        }
    }
    
    async function updateTaskStatus(id, newStatus) {
         try {
            const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, id);
            await updateDoc(taskRef, {
                isDone: newStatus
            });
        } catch (error) {
            console.error("Erro ao atualizar status da tarefa:", error);
        }
    }

    // Inicialização da aplicação
    showLoadingState();

    onAuthStateChanged(auth, (user) => {
      if (user) {
        // Usuário está logado (anonimamente ou não), podemos buscar os dados.
        setupRealtimeListener();
      } else {
        // Usuário não está logado, tentamos o login anônimo.
        signInAnonymously(auth).catch((error) => {
          console.error("Erro no login anônimo:", error);
          showErrorState();
        });
      }
    });

  </script>
</body>
</html>
