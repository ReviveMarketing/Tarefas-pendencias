<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão de Processos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .process-card { transition: all 0.2s ease-in-out; }
        .process-card:hover { transform: scale(1.03); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .checklist-item { display: flex; align-items: center; }
        .checklist-item input:checked + label { text-decoration: line-through; color: #6b7280; }
        .filter-btn-active { background-color: #4f46e5 !important; color: white !important; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-pending { background-color: #f97316; }
        .status-done { background-color: #22c55e; }
        .interactive-btn { transition: all 0.2s ease-in-out; }
        .interactive-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <canvas id="confetti-canvas" class="confetti-canvas"></canvas>

    <header class="bg-indigo-600 text-white pt-8 pb-24 shadow-lg">
        <div class="container mx-auto px-4 md:px-8 max-w-5xl flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold">Painel de Gestão de Processos</h1>
                <p class="text-indigo-200 mt-1">Administração das pendências de clientes "FECHADO".</p>
            </div>
        </div>
    </header>

    <div class="container mx-auto max-w-5xl px-4 md:px-8 -mt-16">
        
        <div id="controls" class="bg-white rounded-lg shadow-xl p-4 md:p-6 mb-6 md:flex md:items-center md:justify-between">
            <div id="stats-section" class="mb-4 md:mb-0">
                <span class="text-sm font-medium text-gray-500">Progresso Geral</span>
                <div class="flex items-center mt-1">
                    <div class="w-40 sm:w-48 bg-gray-200 rounded-full h-2.5 mr-3">
                        <div id="progress-bar" class="progress-bar bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <span id="stats-summary" class="text-base font-semibold text-indigo-600">0/0 (0%)</span>
                </div>
            </div>
            <div id="filters" class="flex space-x-2">
                <button data-filter="all" class="filter-btn filter-btn-active px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition">Todos</button>
                <button data-filter="pending" class="filter-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition">Pendentes</button>
                <button data-filter="done" class="filter-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition">Concluídos</button>
            </div>
        </div>

        <main id="task-list" class="space-y-4">
            <!-- As tarefas serão carregadas aqui -->
        </main>
        <div id="loading-state" class="text-center py-12 bg-white rounded-lg shadow-xl"><p>Carregando...</p></div>
    </div>

    <!-- Modal de Parabéns -->
    <div id="congrats-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 text-center p-8">
            <h3 class="text-2xl font-bold text-green-500">Parabéns!</h3>
            <p class="text-gray-600 mt-2">Processo do cliente concluído com sucesso!</p>
            <button id="congrats-close" class="mt-6 interactive-btn w-full rounded-md border border-transparent bg-indigo-600 px-4 py-2 font-medium text-white hover:bg-indigo-700">Fechar</button>
        </div>
    </div>

    <!-- Modal para Editar Tarefa Principal -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-900">Editar Pendência</h3>
                <p class="text-gray-600 mt-1">Contato: <span id="modal-lead-name" class="font-medium"></span></p>
                <div class="mt-6 space-y-4">
                    <div>
                        <label for="modal-client-name" class="block text-sm font-medium text-gray-700">Nome do Cliente</label>
                        <input type="text" id="modal-client-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modal-comments" class="block text-sm font-medium text-gray-700">Comentários Gerais</label>
                        <textarea id="modal-comments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                 <button type="button" id="modal-cancel" class="rounded-md border border-gray-300 bg-white px-4 py-2 font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
                 <button type="button" id="modal-save" class="interactive-btn rounded-md border border-transparent bg-indigo-600 px-4 py-2 font-medium text-white hover:bg-indigo-700">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Selecionar Processo -->
    <div id="process-select-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl m-4">
            <div class="p-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-900">Selecione o Tipo de Processo</h3>
                    <button id="process-select-close" type="button" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div id="process-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                    <!-- Cards de processo serão inseridos aqui -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1mGiPh3yFeCGuOud-nC17K7mas8tJuMs",
            authDomain: "meu-painel-de-tarefas-d1926.firebaseapp.com",
            projectId: "meu-painel-de-tarefas-d1926",
            storageBucket: "meu-painel-de-tarefas-d1926.firebasestorage.app",
            messagingSenderId: "357152933295",
            appId: "1:357152933295:web:7d447e8b142e25b1c6db5a"
        };
        const appId = 'default-app-id';

        const processTypes = {
            'seguro-vida': { name: 'Seguro de Vida', docs: ['Documento Pessoal', 'Comprovante de Residência', 'B.O./Relato/CAT', 'Prontuário Médico', 'Raio-X', 'Apólice', 'Dados Bancários', 'RTM', 'Folhas de Pagamento', 'Ficha de Empregado', 'Extrato FGTS', 'Prolabore', 'Contrato Social'] },
            'auxilio-acidente': { name: 'Auxílio-Acidente', docs: ['Documento Pessoal', 'Comprovante de Residência', 'CTPS Completa', 'Senha GOV.BR', 'B.O./CAT/Declaração', 'Prontuários', 'Raio-X', 'RTM'] },
            'auxilio-maternidade': { name: 'Auxílio-Maternidade', docs: ['Documento Pessoal', 'Comprovante de Residência', 'CTPS Completa', 'Senha GOV.BR', 'Certidão de Nascimento'] },
            'bpc-loas': { name: 'BPC/LOAS', docs: ['Documento Pessoal (todos da casa)', 'Comprovante de Renda (todos)', 'Comprovante de Residência', 'Senha GOV.BR', 'Laudos Médicos', 'Fotos da Casa', 'Comprovante de Gastos'] },
            'pensao-morte': { name: 'Pensão por Morte', docs: ['Documento Pessoal (falecido e requerente)', 'Certidão de Casamento/Nascimento', 'CTPS do Falecido', 'Senha GOV.BR', 'Certidão de Óbito', 'Comprovantes de Convivência'] },
            'auxilio-doenca': { name: 'Auxílio-Doença', docs: ['Documento Pessoal', 'Atestados Médicos', 'Senha GOV.BR', 'CTPS Completa', 'CAT (se acidente trabalho)', 'Declaração Último Dia Trabalhado'] },
            'seguro-terceiro': { name: 'Seguro Terceiro', docs: ['Documento Pessoal', 'Comprovante de Residência', 'Boletim de Ocorrência', 'RTM', 'Prontuário Médico', 'Raio-X', 'Dados do Seguro do Terceiro', 'Recibos Danos Materiais', 'Fotos do Acidente'] },
            'acao-acidente-transito': { name: 'Ação Acidente de Trânsito', docs: ['Documento Pessoal', 'Comprovante de Residência', 'Boletim de Ocorrência', 'Prontuário Médico', 'Raio-X', 'Recibos Danos Materiais', 'Comprovante de Renda Judicial', 'Extratos Bancários (autônomo)'] }
        };

        let db;
        let currentEditingTaskId = null;
        let allTasks = [];
        let currentFilter = 'all';

        async function main() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            await signInAnonymously(auth);
            listenForTasks();
        }

        function isTaskDone(task) {
            if (!task.processes || task.processes.length === 0) return false;
            return task.processes.every(p => {
                const processData = processTypes[p.type];
                if (!processData) return true; // Processo desconhecido, ignora
                return p.docsChecked && p.docsChecked.length === processData.docs.length && p.docsChecked.every(Boolean);
            });
        }

        function listenForTasks() {
            const tasksCollectionPath = `artifacts/${appId}/public/data/tasks`;
            const q = query(collection(db, tasksCollectionPath), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (querySnapshot) => {
                document.getElementById('loading-state').classList.add('hidden');
                allTasks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateStatisticsAndRender();
            });
        }
        
        function updateStatisticsAndRender() {
            const totalTasks = allTasks.length;
            const completedTasks = allTasks.filter(isTaskDone).length;
            
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('stats-summary').textContent = `${completedTasks}/${totalTasks} (${percentage}%)`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;

            renderTasks();
        }

        function renderTasks() {
            const taskListEl = document.getElementById('task-list');
            taskListEl.innerHTML = '';
            
            const filteredTasks = allTasks.filter(task => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'pending') return !isTaskDone(task);
                if (currentFilter === 'done') return isTaskDone(task);
            });
            
            if (filteredTasks.length > 0) {
              filteredTasks.forEach(task => {
                  taskListEl.appendChild(createTaskElement(task));
              });
            }
        }
        
        function createTaskElement(task) {
            const div = document.createElement('div');
            const taskIsDone = isTaskDone(task);
            div.className = `bg-white p-5 rounded-lg shadow-md border ${taskIsDone ? 'opacity-70' : ''}`;
            
            const processesHTML = (task.processes || []).map(proc => {
                const processData = processTypes[proc.type];
                if (!processData) return '';
                
                const documentsHTML = processData.docs.map((doc, index) => `
                    <div class="checklist-item mt-2">
                        <input type="checkbox" id="doc-${task.id}-${proc.type}-${index}" data-task-id="${task.id}" data-proc-type="${proc.type}" data-doc-index="${index}" ${proc.docsChecked && proc.docsChecked[index] ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="doc-${task.id}-${proc.type}-${index}" class="ml-2 block text-sm text-gray-900">${doc}</label>
                    </div>
                `).join('');
                
                return `
                    <div class="mt-4 border-t pt-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-indigo-700">${processData.name}</h4>
                            <button data-action="remove-process" data-proc-type="${proc.type}" class="p-1 rounded-full hover:bg-red-100 text-red-500" title="Remover Processo">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="mt-2 text-sm">${documentsHTML}</div>
                    </div>
                `;
            }).join('');

            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center">
                        <div class="status-dot ${taskIsDone ? 'status-done' : 'status-pending'} mr-4"></div>
                        <div>
                            <p class="font-bold text-lg text-gray-800">${task.clientName || 'Cliente não definido'}</p>
                            <p class="text-sm text-gray-500">${task.leadName}</p>
                            <p class="text-sm text-gray-600 mt-2"><strong>Comentários:</strong> ${task.comments || 'Nenhum'}</p>
                        </div>
                    </div>
                    <div>
                        <button data-action="edit-main" class="p-2 rounded-full hover:bg-gray-200" title="Editar pendência"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button>
                    </div>
                </div>
                <div id="processes-container-${task.id}">${processesHTML}</div>
                <div class="mt-4">
                    <button data-action="add-process" class="interactive-btn w-full text-center bg-gray-100 hover:bg-gray-200 text-indigo-600 font-semibold py-2 px-4 rounded-lg text-sm">+ Adicionar Processo</button>
                </div>
            `;

            div.addEventListener('click', e => handleTaskClick(e, task));
            return div;
        }

        function handleTaskClick(e, task) {
            const button = e.target.closest('button');
            if (button) {
                const action = button.dataset.action;
                if (action === 'edit-main') {
                    openEditModal(task);
                } else if (action === 'add-process') {
                    openProcessSelectModal(task.id);
                } else if (action === 'remove-process') {
                    const procType = button.dataset.procType;
                    removeProcessFromTask(task.id, procType);
                }
            } else if (e.target.type === 'checkbox') {
                updateChecklist(e.target, task);
            }
        }

        async function removeProcessFromTask(taskId, procType) {
            const task = allTasks.find(t => t.id === taskId);
            const updatedProcesses = (task.processes || []).filter(p => p.type !== procType);
        
            const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            await updateDoc(taskRef, {
                processes: updatedProcesses
            });
        }

        function openEditModal(task) {
            currentEditingTaskId = task.id;
            document.getElementById('modal-lead-name').textContent = task.leadName;
            document.getElementById('modal-client-name').value = task.clientName || '';
            document.getElementById('modal-comments').value = task.comments || '';
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        document.getElementById('modal-cancel').addEventListener('click', () => document.getElementById('edit-modal').classList.add('hidden'));
        document.getElementById('modal-save').addEventListener('click', async () => {
            if (!currentEditingTaskId) return;
            const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, currentEditingTaskId);
            await updateDoc(taskRef, {
                clientName: document.getElementById('modal-client-name').value,
                comments: document.getElementById('modal-comments').value,
            });
            document.getElementById('edit-modal').classList.add('hidden');
        });

        function openProcessSelectModal(taskId) {
            currentEditingTaskId = taskId;
            const processGrid = document.getElementById('process-grid');
            processGrid.innerHTML = '';
            Object.keys(processTypes).forEach(key => {
                const process = processTypes[key];
                const card = document.createElement('div');
                card.className = 'process-card border rounded-lg p-4 text-center cursor-pointer hover:border-indigo-500';
                card.innerHTML = `<p class="font-semibold">${process.name}</p>`;
                card.onclick = () => addProcessToTask(key);
                processGrid.appendChild(card);
            });
            document.getElementById('process-select-modal').classList.remove('hidden');
        }
        
        document.getElementById('process-select-close').addEventListener('click', () => document.getElementById('process-select-modal').classList.add('hidden'));
        document.getElementById('congrats-close').addEventListener('click', () => document.getElementById('congrats-modal').classList.add('hidden'));

        async function addProcessToTask(processType) {
            const task = allTasks.find(t => t.id === currentEditingTaskId);
            const existingProcesses = task.processes || [];
            if (existingProcesses.some(p => p.type === processType)) {
                alert('Este processo já foi adicionado.');
                return;
            }
            
            const newProcess = {
                type: processType,
                docsChecked: Array(processTypes[processType].docs.length).fill(false)
            };

            const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, currentEditingTaskId);
            await updateDoc(taskRef, {
                processes: [...existingProcesses, newProcess]
            });
            document.getElementById('process-select-modal').classList.add('hidden');
        }

        async function updateChecklist(checkbox, task) {
            const wasTaskDoneBefore = isTaskDone(task);
            const { taskId, procType, docIndex } = checkbox.dataset;
            const process = task.processes.find(p => p.type === procType);
            process.docsChecked[docIndex] = checkbox.checked;

            const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            await updateDoc(taskRef, {
                processes: task.processes
            });

            const isTaskDoneNow = isTaskDone(task);
            if (!wasTaskDoneBefore && isTaskDoneNow) {
                showCongrats();
            }
        }
        
        function showCongrats() {
            const congratsModal = document.getElementById('congrats-modal');
            congratsModal.classList.remove('hidden');
            
            const myConfetti = confetti.create(document.getElementById('confetti-canvas'), {
                resize: true,
                useWorker: true
            });
            myConfetti({
                particleCount: 150,
                spread: 180,
                origin: { y: 0.6 }
            });
        }
        
        document.getElementById('filters').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentFilter = e.target.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
                e.target.classList.add('filter-btn-active');
                renderTasks();
            }
        });

        main();
    </script>
</body>
</html>
